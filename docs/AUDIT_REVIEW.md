# Аудит: этикетка, шифрование, FBO (WB/Ozon), UX

**Дата:** 2026-02-05  
**Роли:** Руководитель проекта, SMM, CEO, Собственник, Дизайнер, Elite Senior (код, безопасность, UX)  
**Соответствие плану и целям.**

---

## 1. Соответствие плану и целям

| Пункт плана | Статус | Комментарий |
|-------------|--------|-------------|
| Этикетка 58×40 мм по референсу | ✅ | Название+размер, артикул, поставщик, штрихкод, число под штрихкодом. HTML/CSS под WeasyPrint. |
| Шифрование API-ключей (Fernet) | ✅ | crypto.py, ENCRYPTION_KEY в env, encrypt/decrypt при записи/чтении. Обратная совместимость при пустом ключе. |
| Фикс теста S3 HEAD | ✅ | Мок FILE_PUBLIC_BASE_URL в test_storage.py. |
| Миграция FBO (order_id, fbo_supply_id) | ✅ | 0023: fbo_supply_id в shipment_requests, order_id nullable в fbo_supplies. |
| WB/Ozon API: create_supply, get_barcodes | ✅ | wb_api: create_supply(), get_barcodes() (API v3, marketplace-api.wildberries.ru); ozon_api: create_supply_draft(), get_supply_barcodes(). |
| Эндпоинты /fbo/* | ✅ | list, get, create, sync, import-barcodes. Доступ по компании (владелец или admin/warehouse). |
| Авто-создание FBOSupply при отгрузке WB/Ozon | ✅ | В create_shipment_request при dest WB/Ozon создаётся FBOSupply, проставляется fbo_supply_id. |
| UI: useFBOSupplies, ShippingPage, FBOSupplyDetail | ✅ | Хук, кнопка «FBO поставка», модалка с коробами, синхро, ручной ввод ШК. |
| UX форма API-ключей | ✅ | Ошибка в модалке, подсказка про очистку ключа, исправлены отсутствующие state/hook в CompanyPage. |

**Итог:** Все запланированные пункты закрыты.

---

## 2. Код (Elite Senior)

**Плюсы:**
- Публичные функции/модули с docstrings (pdf, crypto, routes).
- Типизация (Pydantic-схемы, Mapped в моделях).
- Разделение: схемы, роуты, сервисы, крипто — без дублирования логики.
- Обработка ошибок: try/except, логирование, HTTPException с понятными detail.
- FBO: доступ к компании через _get_company_or_404 (роль warehouse/admin или владелец).

**Исправлено по аудиту:**
- Схема FBO: `marketplace` с `Field(..., pattern="^(wb|ozon)$")`; `barcodes` с `max_length=500` против перегрузки.
- В модалке FBO убрано несуществующее `size="sm"` у Button, добавлен показ ошибок синхронизации/импорта (`actionError`).

**Рекомендации:**
- Вынести `from sqlalchemy import func` в начало файла в fbo.py.
- Покрыть тестами: crypto (encrypt/decrypt, fallback при неверном ключе), FBO create/sync/import (моки API).

---

## 3. Безопасность

**Реализовано:**
- API-ключи в БД шифруются (Fernet), ключ в env; при пустом ENCRYPTION_KEY — plaintext (миграция без поломки).
- В ответах ключи маскируются (_mask_key), в логах нет сырых ключей.
- Доступ к компаниям и FBO: проверка user_id или роль admin/warehouse.
- Ввод в PDF (название, артикул, поставщик, штрихкод) экранируется через html.escape.
- Валидация: marketplace wb|ozon в схеме; лимит на список barcodes (500).

**Рекомендации:**
- Ограничить длину полей в CompanyAPIKeysUpdate (max_length), если ещё не ограничено на уровне БД.
- При ротации ENCRYPTION_KEY предусмотреть перешифрование существующих записей (отдельный скрипт/миграция).

---

## 4. Удобство (UX) и дизайн

**Плюсы:**
- Форма API-ключей: ошибка сохранения в модалке, подсказка «пустое значение = очистить ключ».
- FBO: одна модалка — короба, синхронизация, ручной ввод ШК; ошибки sync/import показываются в той же модалке.
- Состояния загрузки: «Загрузка...», «Синхронизация...», «Импорт...», «Сохранение...».
- Кнопка «FBO поставка» только при наличии fbo_supply_id — не загромождает интерфейс.

**Рекомендации:**
- После успешного sync/import показывать краткий success (toast или текст в модалке).
- В модалке FBO при отсутствии external_supply_id явно написать: «Создайте поставку в кабинете WB/Ozon или дождитесь авто-создания при отгрузке».

---

## 5. SMM / коммуникация с пользователем

**Тексты:**
- Сообщения об ошибках на русском, по делу («Укажите API-ключ Wildberries...», «marketplace должен быть wb или ozon», «Поставка не найдена»).
- Подсказки в формах (API-ключи, ручной ввод ШК) понятны.

**Рекомендации:**
- Унифицировать тон (обращение на «вы» везде).
- В DEPLOYMENT.md уже добавлена инструкция по ENCRYPTION_KEY — достаточно.

---

## 6. CEO / собственник бизнеса

**Цели:**
- Клиенты могут отгружать на WB/Ozon с проверкой ключей и созданием FBO.
- Ключи хранятся безопасно (шифрование), этикетка соответствует референсу для печати.
- Ручной ввод и импорт ШК дают гибкость при сбоях API маркетплейсов.

**Риски:**
- Реальные эндпоинты WB/Ozon (create_supply, create_supply_draft) могут отличаться по контракту — при внедрении проверить по актуальной документации и при необходимости поправить запросы/ответы.

**Обновление интеграций (после аудита):**
- WB: реализован `create_supply()`, переход на API v3 (marketplace-api.wildberries.ru), добавлен `get_supply_boxes`, `create_supply_boxes`, `get_box_stickers`. Разделены ID короба (`external_box_id`) и сканируемый ШК (`external_barcode`).
- Ozon: улучшен парсинг штрихкодов в `get_supply_barcodes()` (учтены `barcodes`, `package.barcodes`, `packages[0].barcodes`).

**Сценарии WB (ШК коробов):**
- **Авто:** при создании отгрузки или FBO поставки укажите «Число коробов» > 0 — в WB создаётся поставка и короба, после синхронизации появятся ID коробов и кнопка «Получить стикеры коробов».
- **Вручную:** без числа коробов создаётся локальная FBO-поставка (draft). Создайте поставку и короба в кабинете WB, затем нажмите «Синхронизировать короба из маркетплейса» — ШК подтянутся. Если штрихкодов нет — возможна ручная вставка или импорт списка.

---

## 7. Итоговая оценка

| Критерий | Оценка |
|----------|--------|
| Соответствие плану | ✅ 100% |
| Качество кода | ✅ Высокое, есть мелкие улучшения |
| Безопасность | ✅ Шифрование, маскирование, доступ по компании |
| Удобство (UX) | ✅ Ошибки и подсказки на месте, доработки по мелочи |
| Дизайн/тексты | ✅ Консистентно, без лишнего |

**Внесённые правки по аудиту:**
1. FBO-схемы: валидация `marketplace` (wb|ozon), лимит `barcodes` (500).
2. Модалка FBO: убран несуществующий `size="sm"`, добавлен показ ошибок sync/import и обработчик `handleSync` с сбросом ошибки.

Проект готов к деплою с учётом применения миграций и при необходимости настройки ENCRYPTION_KEY.
