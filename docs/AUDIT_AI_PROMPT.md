# Аудит: улучшение AI-промпта (план «Улучшение AI промпта»)

**Дата:** 2026-02-05  
**Роли:** Руководитель проекта, SMM, CEO, Собственник, Дизайнер, Elite Senior (код, безопасность, UX)  
**Цель:** Проверка соответствия плану, качества кода, безопасности, удобства и целям бизнеса.

---

## 1. Соответствие плану и намеченным целям

| Пункт плана | Статус | Комментарий |
|-------------|--------|-------------|
| Исправить несоответствие get_stock_summary и промпта | ✅ | В `ai_tools.py` добавлены поля `orders_total_planned`, `orders_total_received`, `orders_total_packed`; описание TOOLS обновлено. |
| Обновить AI_SYSTEM_INSTRUCTION | ✅ | Развёрнутый промпт с разделами: tools, остатки, заявки, упаковка, брак, формат ответов, ограничения. |
| Рефакторинг RAG: убрать дублирование, отдельное system message | ✅ | STATIC_BASE без идентичности; `build_rag_context_async` возвращает `(rag_system, user_message)`; в `ai.py` RAG передаётся отдельным system-сообщением. |
| Инструкции по обработке ошибок от tools | ✅ | В промпте: «Если функция вернула ошибку (поле "error") — объясни понятным языком; при «Не указана компания» — направь выбрать компанию». |
| Тестирование | ✅ | Добавлен `tests/test_rag.py` (3 теста); исправлена отступность в TOOLS; RAG- и AI-связанные тесты проходят. |

**Итог:** Все пункты плана выполнены.

---

## 2. Код (Elite Senior)

**Плюсы:**
- Публичные функции/модули с docstrings (rag.build_rag_context_async, build_rag_context, ai.py chat).
- Типизация: возврат `tuple[str | None, str]` у `build_rag_context_async`, Pydantic-схемы.
- Разделение: промпт в роуте, RAG в сервисе, tools в ai_tools — без дублирования логики.
- В `get_stock_summary` два запроса к БД (products, orders) — читаемо; при росте нагрузки можно объединить в один при необходимости.
- Ошибки в tools логируются через `logger.exception` в `execute_tool`.

**Исправлено по аудиту:**
- В `ai_tools.py` исправлена отступность элемента списка TOOLS для `get_stock_summary` (единообразие с остальными элементами).
- В `app/schemas/ai.py` для `AIChatRequest.message` добавлены `Field(min_length=1, max_length=8000)` — защита от пустого ввода и ограничение длины (токены/DoS).
- Обновлён `docs/AI.md`: актуальное описание RAG (tuple, отдельное system message) и системного промпта.

**Рекомендации:**
- Вынести константу промпта из тела обработчика (например, модуль-уровень в `ai.py` или отдельный модуль `app/services/ai_prompt.py`) при дальнейшем росте текста.
- Покрыть тестом сценарий `build_rag_context_async` при наличии чанков в БД (с моком эмбеддингов и pgvector), когда появятся тесты на реальной БД/моках для RAG.

---

## 3. Безопасность

**Реализовано:**
- Доступ к данным по компании по-прежнему через `_ensure_company` (client — только свои компании, warehouse/admin — по company_id); новые поля в `get_stock_summary` считаются в рамках той же компании.
- В промпте заданы ограничения: не отвечать на офтопик, вежливо перенаправлять — снижает риск увода разговора и разглашения контекста.
- Обработка ошибок tools (в т.ч. «Не указана компания») не раскрывает внутреннюю структуру, только пользовательские сообщения.
- В схеме запроса: `message` с `min_length=1`, `max_length=8000` — ограничение размера ввода и снижение риска переполнения контекста/затрат на токены.

**Рекомендации:**
- При необходимости ужесточить лимит — уменьшить `max_length` (например, 4000) или ввести rate limit на эндпоинт `/ai/chat` (если ещё не задан глобально).
- Системный промпт и RAG-контекст не содержат пользовательских данных; пользовательский ввод идёт только в `user` message — разделение ролей соблюдено.

---

## 4. Удобство (UX) и дизайн

**Плюсы:**
- Единый тон: «вы», кратко, по делу, без эмодзи — подходит для Telegram Mini App и деловой коммуникации.
- Чёткие инструкции по формату (markdown, списки) — ответы легче читать в интерфейсе.
- При ошибке «Не указана компания» модель направляет в приложение — понятное действие для пользователя.
- Отдельное system-сообщение для RAG: модель получает контекст документации отдельно от запроса пользователя, что уменьшает путаницу и улучшает релевантность ответов.

**Рекомендации:**
- На фронте при отображении ответа убедиться, что markdown рендерится (если ещё не везде); при необходимости добавить подсказку «Можно спросить про остатки, заявки, прайс» при пустой истории.

---

## 5. SMM / коммуникация с пользователем

**Тексты:**
- Сообщения об ошибках в tools на русском («Не указана компания. Выберите компанию в приложении.» и т.п.).
- Фраза перенаправления по офтопику: «Я помогаю с вопросами о заявках, товарах и услугах фулфилмента. Чем могу помочь?» — вежливо и по делу.
- Промпт явно задаёт обращение на «вы» и только на русском — единый стиль бренда.

**Рекомендации:**
- Унифицировать тон во всём приложении (как в AUDIT_REVIEW.md): везде «вы», без переключения на «ты».

---

## 6. CEO / собственник бизнеса

**Цели:**
- Клиенты получают корректную сводку по остаткам и заявкам (плановое/принято/упаковано) без галлюцинаций — данные из БД.
- Бот остаётся в рамках темы фулфилмента и не уходит в общие темы — защита репутации и фокуса сервиса.
- Ошибки (нет компании, сбой tools) переводятся в понятные пользователю формулировки — меньше обращений в поддержку.

**Риски:**
- Зависимость от качества и актуальности загруженной RAG-документации (WB/Ozon и т.д.) — рекомендовано периодически обновлять документы и проверять ответы по типовым вопросам.

---

## 7. Итоговая оценка

| Критерий | Оценка |
|----------|--------|
| Соответствие плану | ✅ 100% |
| Качество кода | ✅ Высокое; исправлены отступы, добавлена валидация message, обновлена документация |
| Безопасность | ✅ Ограничение длины ввода, доступ по компании, офтопик-ограничения в промпте |
| Удобство (UX) | ✅ Единый тон, формат ответов, понятные действия при ошибках |
| Дизайн/тексты | ✅ Консистентно, без лишнего |

**Внесённые правки по аудиту:**
1. `ai_tools.py`: единообразная отступность элемента TOOLS для `get_stock_summary`.
2. `app/schemas/ai.py`: `message = Field(..., min_length=1, max_length=8000)`.
3. `docs/AI.md`: актуальное описание RAG и системного промпта; уточнено описание get_stock_summary.

Изменения готовы к использованию в проде с учётом рекомендаций выше.
